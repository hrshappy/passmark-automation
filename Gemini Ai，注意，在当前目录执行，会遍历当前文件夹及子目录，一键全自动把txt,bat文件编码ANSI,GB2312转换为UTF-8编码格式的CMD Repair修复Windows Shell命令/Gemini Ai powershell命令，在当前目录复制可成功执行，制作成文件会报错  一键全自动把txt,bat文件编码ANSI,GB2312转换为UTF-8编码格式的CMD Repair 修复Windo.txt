# --- 请根据你的诊断结果，在这里修改原始编码的准确名称 ---
$sourceEncodingName = "GB2312"  # <--- 如果是繁体中文文件，就改成 "Big5"
# -------------------------------------------------------------

# 在这里指定所有需要转换的文件类型
$fileTypes = "*.txt", "*.bat"

Get-ChildItem -Path ".\*" -Include $fileTypes -Recurse | ForEach-Object {
    try {
        # 步骤1: 使用 .NET 创建一个精确的源文件编码对象 (例如 GB2312)
        $sourceEncoding = [System.Text.Encoding]::GetEncoding($sourceEncodingName)
        
        # 步骤2: 使用 .NET 直接以该编码读取所有文本内容
        $content = [System.IO.File]::ReadAllText($_.FullName, $sourceEncoding)
        
        # 步骤3: 创建一个不带BOM的UTF-8编码器
        $utf8Encoding = New-Object System.Text.UTF8Encoding($false)
        
        # 步骤4: 使用 .NET 将正确读取的内容以UTF-8格式写回文件
        [System.IO.File]::WriteAllText($_.FullName, $content, $utf8Encoding)
        
        Write-Host "成功转换: $($_.FullName)"
    } catch {
        # 捕获所有可能的错误
        Write-Warning "转换失败: $($_.FullName) - $($_.Exception.Message)"
    }
}